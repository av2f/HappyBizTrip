<script>
  // position of footer for screen >=768 px
  $(function () {
    if ($(window).width() >= 768) {
      var bht = $('body').height()
      var wht = $(window).height()
      if (bht < wht) {
        $('footer').css('position', 'absolute')
      }
    }
  })

  // handle connect button
  document.querySelectorAll('.btn-action').forEach(action => 
    action.addEventListener('click', (e) => { 
      e.preventDefault()
      var clickAction = action.getAttribute('id').substring(0,2)
      var badgeId = 'B_' + action.getAttribute('id').substring(action.getAttribute('id').indexOf('_', 1) + 1, action.getAttribute('id').length)
      // handle action on click
      switch (clickAction) {
        case 'CO':  // click on connect button
          sendJsonRequest(action.getAttribute('href'), action.dataset.token, 'CO')
          .then(response => {
            if (response.success) {
              // display badge
              badge(badgeId, 'none', 'inline',"{{ 'connection.requested'|trans|raw }}")
              // change type and string of action for button
              var newId = action.getAttribute('id').replace('CO', 'CA')
              action.setAttribute('id', newId)
              action.innerHTML = "{{ 'generic.cancel'|trans|raw }}"
            }
            else {
              console.log('foireux')
            }
          })
          .catch(e => alert(e))
          break
        case 'CA':  // Cancel
          sendJsonRequest(action.getAttribute('href'), action.dataset.token, 'CA')
          .then(response => {
            if (response.success) {
              // reset & hide badge
              badge(badgeId, 'inline', 'none', '')
              // change type and string of action for button
              var newId = action.getAttribute('id').replace('CA', 'CO')
              action.setAttribute('id', newId)
              action.innerHTML = "{{ 'generic.connect'|trans|raw }}"
            }
            else {
              console.log('foireux')
            }
          })
          .catch(e => alert(e))
          break
        case "AC":  // Accept
          sendJsonRequest(action.getAttribute('href'), action.dataset.token, 'AC')
          .then(response => {
            if (response.success) {
              // reset & hide badge
              badge(badgeId, 'inline', 'none', '')
              // change type and string of action for button
              var newId = action.getAttribute('id').replace('AC', 'ME')
              action.setAttribute('id', newId)
              action.innerHTML = "{{ 'generic.message'|trans|raw }}"
            }
            else {
              console.log('foireux')
            }
          })
          .catch(e => alert(e))
          break

        default:
          break
      }
    })
  )

  // handle dropdown-item 
  document.querySelectorAll('.dropdown-item-action').forEach(item => 
    item.addEventListener('click', (e) => { 
      e.preventDefault()
      var clickItem = item.getAttribute('id').substring(0,2)
      var userId = item.getAttribute('id').substring(item.getAttribute('id').indexOf('_', 1) + 1, item.getAttribute('id').length)
      var btnGrpId = 'BG_' + userId
      console.log(clickItem + ' ' + item.innerHTML)
      console.log(btnGrpId + ' ' + userId)
      switch (clickItem) {
        case 'BL':  // Block user
          sendJsonRequest(item.getAttribute('href'), item.dataset.token, 'BL')
          .then(response => {
            if (response.success) {

              console.log("et oh j'y suis")

              // change type and string of action for button
              // var btnId = 'ME_' + 
              var newId = item.getAttribute('id').replace('BL', 'UN')
              item.setAttribute('id', newId)
              item.innerHTML = "{{ 'generic.unlock'|trans|raw }}"
              // hide action item
              if (document.getElementById('BG_' + userId).style.display == 'inline') {
                document.getElementById('BG_' + userId).style.display = 'none'
              }
            }
            else {
              console.log('foireux')
            }
          })
          .catch(e => alert(e))
          break
        default:
          break
      }
    })
  )

  /* 
  Manage json request with promise
  href  : url to send request
  theToken  : token
  action  :
    CO = Connect
    CA = Cancel
    AC = Accept
  */

  function sendJsonRequest(href, theToken, action)
  {
    return fetch(href, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({'_token': theToken, 'action': action})
    })
    .then( response => response.json() )
    .then(data => { return data })
  }

  /*
  Display or hide the badge
  badgeId : id of the badge to change state
  displayScr  : value of original style display
  displayDest : value of style display after change
  textBadge : Text for badge
  */
  function badge(badgeId, displaySrc, displayDest, textBadge)
  {
    if (document.getElementById(badgeId).style.display === displaySrc) {
      document.getElementById(badgeId).innerHTML = textBadge
      document.getElementById(badgeId).style.display = displayDest
    }
  }

</script>
